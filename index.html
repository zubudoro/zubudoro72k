<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Nailie</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(#b2fefa, #0ed2f7);
      max-width: 100%;
    }
    #container {
      padding: 10px;
      max-width: 480px;
      margin: 0 auto;
    }
    img#nailImage {
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    #messages {
      height: 600px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      background-color: #ffffffa0;
      padding: 10px;
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .kenji {
      background-color: #d4fcd4;
      color: green;
      align-self: flex-start;
    }
    .nacchan {
      background-color: #d4e8fc;
      color: blue;
      align-self: flex-end;
    }
    #passwordScreen, #chatScreen {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    textarea, input, select {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
    }
    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="passwordScreen">
      <img src="nail.jpeg" id="nailImage" alt="nail">
      <p>パスワードを入力してください</p>
      <input type="password" id="passwordInput" placeholder="パスワード">
      <button onclick="checkPassword()">確認</button>
    </div>

    <div id="chatScreen" style="display:none;">
      <h2>Nailie</h2>
      <div id="messages"></div>
      <select id="name">
        <option value="けんじ">けんじ</option>
        <option value="なっちゃん">なっちゃん</option>
      </select>
      <textarea id="message" rows="3" placeholder="メッセージ"></textarea>
      <input type="file" id="imageInput" accept="image/*">
      <button onclick="sendMessage()">送信</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDka0qWoys874fA2GbVhGGecLtCoze2Pzw",
      authDomain: "zubudoro-chat.firebaseapp.com",
      projectId: "zubudoro-chat",
      storageBucket: "zubudoro-chat.appspot.com",
      messagingSenderId: "476549774973",
      appId: "1:476549774973:web:3b4923256340bd4a3c3b14"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const messagesRef = collection(db, "messages");

    const q = query(messagesRef, orderBy("timestamp"));
    const messagesDiv = document.getElementById("messages");

    onSnapshot(q, async (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((doc) => {
        const d = doc.data();
        const alignClass = d.name === "けんじ" ? "kenji" : "nacchan";
        const time = d.timestamp?.toDate?.().toLocaleString() || "";
        let msgHTML = `<div class="message ${alignClass}"><strong>${d.name}</strong><br>${d.message}<br><small>${time}</small>`;
        if (d.imageUrl) {
          msgHTML += `<br><img src="${d.imageUrl}" style="max-width:100%;border-radius:8px;">`;
        }
        msgHTML += "</div>";
        messagesDiv.innerHTML += msgHTML;
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    window.sendMessage = async () => {
      const name = document.getElementById("name").value;
      const message = document.getElementById("message").value;
      const imageInput = document.getElementById("imageInput");
      let imageUrl = "";

      if (imageInput.files.length > 0) {
        const imageFile = imageInput.files[0];
        const imageRef = ref(storage, `images/${Date.now()}_${imageFile.name}`);
        await uploadBytes(imageRef, imageFile);
        imageUrl = await getDownloadURL(imageRef);
      }

      await addDoc(messagesRef, {
        name,
        message,
        imageUrl,
        timestamp: serverTimestamp()
      });

      document.getElementById("message").value = "";
      imageInput.value = "";
    };

    window.checkPassword = () => {
      const input = document.getElementById("passwordInput").value;
      if (input === "0728") {
        document.getElementById("passwordScreen").style.display = "none";
        document.getElementById("chatScreen").style.display = "flex";
      } else {
        alert("パスワードが違います");
      }
    };
  </script>
</body>
</html>
